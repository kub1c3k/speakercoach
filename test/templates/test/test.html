{% extends "base.html" %}
{% load static %}

{% block extra_head %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{% static 'css/style.css' %}">

{% endblock %}

{% block content %}
<div class="container">
    <h1>游꿗 Inteligentn칳 kou캜 re캜n칤ctva</h1>
    <p class="subtitle">Analyzujte a zlep코ite svoj o캜n칳 kontakt a re캜n칤cke schopnosti</p>
    
    <div class="media-container">
        <div class="video-wrapper">
            <video id="inputVideo" autoplay playsinline muted></video>
            <div class="video-label">Vstup z kamery</div>
        </div>
        
        <div class="canvas-wrapper">
            <canvas id="outputCanvas"></canvas>
            <div class="canvas-label">Anal칳za v re치lnom 캜ase</div>
        </div>
    </div>
    
    <div id="eye_contact_info" class="results-container">
        <h3>游뱋 Anal칳za o캜n칠ho kontaktu</h3>
        <p id="test_info">Nastavte d컄쬶u prejavu a za캜nite test</p>
        
        <div id="test_status" class="pulse">
            캛ak치m na spustenie...
        </div>
        
        <div id="live_feedback">
        </div>
        
        <div class="progress-container">
            <div id="progress_bar_container">
                <div id="progress_bar"></div>
            </div>
            <div class="progress-labels">
                <span>0%</span>
                <span>50%</span>
                <span>100%</span>
            </div>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Celkov칳 캜as</div>
                <div class="stat-value" id="totalTime">0:00</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">O캜n칳 kontakt</div>
                <div class="stat-value" id="eyeContactScore">0%</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Konzistentnos콘</div>
                <div class="stat-value" id="consistencyScore">0%</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Spokojnos콘</div>
                <div class="stat-value" id="confidenceScore">0%</div>
            </div>
        </div>
        
        <div class="button-container">
            <button id="start_button" onclick="startCamera()">
                游 Spusti콘 test
            </button>
            <button class="secondary-button" onclick="calibrationManager.startCalibration()">
                丘뙖잺 Kalibr치cia
            </button>
            <button class="secondary-button" onclick="showHistory()">
                游늵 Hist칩ria
            </button>
        </div>
    </div>
    
    <div class="history-panel" id="historyPanel" style="display: none;">
        <h4>游늳 Hist칩ria pokusov</h4>
        <div class="history-list" id="historyList">
        </div>
    </div>
    
    <div class="instructions">
        <h4>游눠 Ako dosiahnu콘 najlep코ie v칳sledky:</h4>
        <ol>
            <li>Vykonajte kalibr치ciu pred prv칳m pou쬴t칤m</li>
            <li>Umiestnite sa 50-100 cm od kamery</li>
            <li>Dobr칠 osvetlenie tv치re zlep코uje presnos콘</li>
            <li>Pravideln칠 cvi캜enie vedie k trval칠mu zlep코eniu</li>
        </ol>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>

<script src="{% static 'js/eyecontact.js' %}"></script>

<script>
function showHistory() {
    const panel = document.getElementById('historyPanel');
    const list = document.getElementById('historyList');
    
    const history = sessionManager.getProgressReport(10);
    
    if (history.length === 0) {
        list.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">콯iadna hist칩ria</p>';
    } else {
        let html = '';
        history.forEach(item => {
            html += `
                <div class="history-item">
                    <span>${item.date}</span>
                    <span><strong>${item.score}</strong></span>
                    <span>${item.duration}</span>
                    <span>${item.improvement}</span>
                </div>
            `;
        });
        list.innerHTML = html;
    }
    
    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
}

// Aktualiz치cia statistik v re치lnom 캜ase
function updateStatsUI() {
    if (sessionManager.currentSession && sessionManager.currentSession.frames.length > 0) {
        const frames = sessionManager.currentSession.frames;
        const lastFrame = frames[frames.length - 1];
        
        document.getElementById('eyeContactScore').textContent = 
            Math.round(lastFrame.eyeContactScore) + '%';
        document.getElementById('confidenceScore').textContent = 
            Math.round(lastFrame.confidence * 100) + '%';
        
        // Vypo캜칤taj 캜as
        if (appState.testStartTime) {
            const elapsed = Date.now() - appState.testStartTime;
            const minutes = Math.floor(elapsed / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            document.getElementById('totalTime').textContent = 
                `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
    }
}

// Pravideln치 aktualiz치cia UI
setInterval(updateStatsUI, 1000);
</script>
{% endblock %}